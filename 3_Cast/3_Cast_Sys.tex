\section{Cast System}

% why cast soundness?
In a programming language, type soundness proves some undesirable behaviors are unreachable from a well typed term.
% Recall that type soundness is the primary property for a typed programming language to exhibit.
How should this apply to the cast language, where bad behaviors are intended to be reachable?
The cast language allows the program to be stuck in a bad state, but require that when that state is reached we blame the original faulty type assumption.
Where the slogan for type soundness is ``well typed terms don't get stuck'', the slogan for cast soundness is ``well cast terms don't get stuck without blame''.

In \ch{2} we proved type soundness for a minimal dependently typed language, with a progress and preservation style proof given a suitable definition of term equivalence.
We can extend that proof to support cast soundness with only a few modifications.

\begin{figure}
\[
\frac{x:A\in H}{H\vdash x\,:\,A}
\rulename{cast-var}
\]
\[
\frac{H\vdash a:A\quad H\vdash A:\star\quad H\vdash B:\star}{H\vdash a::_{A,\ell ,o}B\::\:B}
\rulename{cast-::}
\]

\[
\frac{\,}{H\vdash\star:\,\star}
\rulename{cast-\star}
\]

\[
\frac{H\vdash A:\star\quad H,x:A\vdash B:\star}{H\vdash\left(x:A\right)\rightarrow B\,:\,\star}
\rulename{cast-fun-ty}
\]

\[
\frac{H,f:\left(x:A\right)\rightarrow B,x:A\vdash b:B}{H\vdash\mathsf{fun}\,f\,x\Rightarrow b\,:\,\left(x:A\right)\rightarrow B}
\rulename{cast-fun}
\]

\[
\frac{H\vdash b:\left(x:A\right)\rightarrow B\quad H\vdash a:A}{H\vdash b\,a\,:\,B\left[x\coloneqq a\right]}
\rulename{cast-fun-app}
\]

\[
\frac{H\vdash a:A\quad A\equiv A'}{H\vdash a:A'}
\rulename{cast-conv}
\]

\todo[inline]{review regularity stuff}

\caption{Cast Language Type Assignment Rules}
\label{fig:cast-tas-rules}
\end{figure}

The cast language supports its own type assignment system, defined in \Fref{cast-tas-rules}.
This system ensures that computations will not get stuck without enough information for good runtime error messages.
Specifically computations will not get stuck without a source location and a witness of inequality.
The only rule that types differently than the surface language is the \rulename{cast-::} rule that allows runtime type assertions. 

As before we need a suitable reduction relation to generate our equivalence relation.
\Fref{cast-reduction} shows that system of reductions.
The full rule for function reduction is given in \rulename{\Rrightarrow-fun-::-red} which makes the behavour from the examples explicit: agrument types are swapped as a term is applied under a cast.
Casts from a type universe to a type universe are allowed by the \rulename{\Rrightarrow-::-red} rule.
Since observations embed expressions, they must also be given parallel reductions.

\begin{figure}
\[
\frac{b\Rrightarrow b'\quad a\Rrightarrow a'}{\left(\mathsf{fun}\,f\,x\Rightarrow b\right)a\Rrightarrow b'\left[f\coloneqq\mathsf{fun}\,f\,x\Rightarrow b',x\coloneqq a'\right]}
\rulename{\Rrightarrow-fun-app-red}
\]

\[
\frac{b\Rrightarrow b'\quad a\Rrightarrow a'\quad A_{1}\Rrightarrow A_{1}'\quad A_{2}\Rrightarrow A_{2}'\quad B_{1}\Rrightarrow B_{1}'\quad B_{2}\Rrightarrow B_{2}'\quad o\Rrightarrow o'}{\begin{array}{c}
\left(b::_{\left(x:A_{1}\right)\rightarrow B_{1},\ell ,o}\left(x:A_{2}\right)\rightarrow B_{2}\right)a\Rrightarrow\\
\left(b'\,a'::_{A_{2}',\ell,o.arg}A_{1}'\right)::_{B_{1}'\left[x\coloneqq a'::_{A_{2}',\ell,o.arg}A_{1}'\right],\ell ,o'.bod[a']}B_{2}'\left[x\coloneqq a'\right]
\end{array}}
\rulename{\Rrightarrow-fun-::-red}
\]

\[
\frac{a\Rrightarrow a'}{a::_{\star,\ell,o}\star\Rrightarrow a'}
\rulename{\Rrightarrow-::-red}
\]

\[
\frac{\,}{x\Rrightarrow x}
\rulename{\Rrightarrow-var}
\]
\[
\frac{a\Rrightarrow a'\quad A_{1}\Rrightarrow A_{1}'\quad A_{2}\Rrightarrow A_{2}'\quad o\Rrightarrow o'}{a::_{A_{1},\ell ,o}A_{2}\Rrightarrow a'::_{A_{1}',\ell ,o'}A_{2}'}
\rulename{\Rrightarrow-::}
\]

\[
\frac{\,}{\star\Rrightarrow\star}
\rulename{\Rrightarrow-}\star
\]

\[
\frac{A\Rrightarrow A'\quad B\Rrightarrow B'}{\left(x:A\right)\rightarrow B\Rrightarrow\left(x:A'\right)\rightarrow B'}
\rulename{\Rrightarrow-fun-ty}
\]

\[
\frac{b\Rrightarrow b'}{\mathsf{fun}\,f\,x\Rightarrow b\,\Rrightarrow\,\mathsf{fun}\,f\,x\Rightarrow b'}
\rulename{\Rrightarrow-fun}
\]

\[
\frac{b\Rrightarrow b'\quad a\Rrightarrow a'}{b\,a\Rrightarrow b'\,a'}
\rulename{\Rrightarrow-fun-app}
\]

\[
\frac{\,}{.\Rrightarrow.}
\rulename{\Rrightarrow-obs-emp}
\]

\[
\frac{o\Rrightarrow o'}{o.arg\Rrightarrow o'.arg}
\rulename{\Rrightarrow-obs-arg}
\]

\[
\frac{o\Rrightarrow o'\quad a\Rrightarrow a'}{o.bod[a]\Rrightarrow o'.bod[a']}
\rulename{\Rrightarrow-obs-bod}
\]

\[
\frac{\,}{a\Rrightarrow_{\ast}a}
\rulename{\Rrightarrow_{\ast}-refl}
\]
\[
\frac{a\Rrightarrow_{\ast}a'\quad a'\Rrightarrow a''}{a\Rrightarrow_{\ast}a''}
\rulename{\Rrightarrow_{\ast}-trans}
\]
\[
\frac{a\Rrightarrow_{\ast}a''\quad a'\Rrightarrow_{\ast}a''}{a\equiv a'}
\rulename{\equiv-def}
\]

\caption{Cast Language Parallel Reductions}
\label{fig:cast-reduction}
\end{figure}

\subsection{Definitional Equality}

As in \ch{2}, we will define a suitable notions of deffinitionaltional equality to derive the other properties of the system.
While it may seem counterintuitive to define a definitional equality in a system that is intended to avoid definitional equality, it is fine since programmars will never interact directly with cast checking.
The cast system only exists to give theoretical assurances.

As before $\Rrightarrow_{*}$ can be shown to be confluent, and used to geernate the equality relation.
The proofs follow the same structure as \ch{2}, but since observations can contain terms, $\Rrightarrow$ and $\textbf{max}$ must be extended to observations.
Proofs must be extended to mutually induct on observations, since they can contain expressions that could also reduce.

The explicit new rules for $\textbf{max}$  are given in \Fref{cast-sys-max} with the structural rules from \ch{2} ommitted.


\begin{sidewaysfigure}
\begin{tabular}{cccll}
$\textbf{max}($ & $\left(\mathsf{fun}\,f\,x\Rightarrow b\right)\,a$ & $)=$ & $\textbf{max}\left(b\right)\left[f\coloneqq\mathsf{fun}\,f\,x\Rightarrow \textbf{max}\left(b\right),x\coloneqq \textbf{max}\left(a\right)\right]$ \tabularnewline
$\textbf{max}($ & 
$\left(b::_{\left(x:A_{1}\right)\rightarrow B_{1},\ell ,o}\left(x:A_{2}\right)\rightarrow B_{2}\right)a$ & $)=$ & 
\makecell[l]{
  $\left(\textbf{max}\left(b\right)\,\left(\textbf{max}\left(a\right)::_{\textbf{max}\left(A_{2}\right),\ell,\textbf{max}\left(o\right).arg}\textbf{max}\left(A_{1}\right)\right)\right)$ \\
  $::_{\textbf{max}\left(B_{2}\right)\left[x\coloneqq \textbf{max}\left(a\right)::_{\textbf{max}\left(A_{2}\right),\ell,\textbf{max}\left(o\right).arg}\textbf{max}\left(A_{1}\right)\right],\ell ,\textbf{max}\left(o\right).bod[\textbf{max}\left(a\right)]}$ \\
  $\textbf{max}\left(B_{2}\right)\left[x\coloneqq \textbf{max}\left(a\right)\right]$
} & \tabularnewline
& & & otherwise \tabularnewline
$\textbf{max}($ & $b::_{B_{1},\ell ,o}B_{2}$ & $)=$ & $\textbf{max}\left(b\right)::_{\textbf{max}\left(B_{1}\right),\ell ,\textbf{max}\left(o\right)}\textbf{max}\left(B_{2}\right)$ \tabularnewline

$\textbf{max}($ & ... & $)=$ & ... % corresponds to the definition in chapter 2
\tabularnewline
% $\textbf{max}($ & $.$ & $)=$ & $.$ & \tabularnewline
$\textbf{max}($ & $o.arg$ & $)=$ & $\textbf{max}\left(o\right).arg$ \tabularnewline
$\textbf{max}($ & $o.bod[a]$ & $)=$ & $\textbf{max}\left(o\right).bod[\textbf{max}\left(a\right)]$ \tabularnewline
\end{tabular}
\todo{actually have all the rules but grey out the redundant ones}
\caption{$\textbf{max}$}
\label{fig:cast-sys-max}
\end{sidewaysfigure}
 
The expected lemas hold.

\begin{lem}
Triangle properties

If $a\Rrightarrow a'$ then $a'\Rrightarrow max\left(a\right)$ 
If $o\Rrightarrow o'$ then $o'\Rrightarrow max\left(o\right)$
\end{lem}

\begin{proof}
by mutual induction on the derivations of $m\Rrightarrow\,m'$ and
$o\Rrightarrow o'$.
\end{proof}
\todo{check this}
\begin{lem}
Diamond property 

If $a\Rrightarrow a'$, $a\Rrightarrow a''$, implies $a'\Rrightarrow\,max\left(a\right)$, $a''\Rrightarrow\,max\left(a\right)$ 
\end{lem}

\begin{proof}
Follows directly from triangle property
\end{proof}

\subsubsection{$\equiv$ is an equivelence}

\todo{more connective tissue?}
\begin{thm}
$\equiv$ is transitive

If $a\equiv a'$, $a'\equiv a''$, implies $a\equiv a''$ 
\end{thm}

\begin{proof}
The diamond property implies the confluence of $\Rrightarrow_{\ast}$.
\end{proof}

\subsubsection{stability}
Similar to \ch{2} we need to prove that equlity is stable over type constructors.
\begin{lem}
Stability (generalized)

$\forall A,B,C.\left(x:A\right)\rightarrow B\Rrightarrow_{\ast}C\:\Rightarrow\:\exists A',B'.C=\left(x:A'\right)\rightarrow B'\land A\Rrightarrow_{\ast}A'\land B\Rrightarrow_{\ast}B'$
\end{lem}

\begin{proof}
by induction on $\Rrightarrow_{\ast}$
\end{proof}
\begin{cor}
Stability

The following rule is admissible
\[
\frac{\left(x:A\right)\rightarrow B\equiv\left(x:A'\right)\rightarrow B'}{A\equiv A'\quad B\equiv B'}
\]
\end{cor}


\subsection{Preservation}
\begin{lem}
Context Weakening

The following rule is admissible

\[
\frac{H\vdash a:A}{H,H'\vdash a:A}
\]
\end{lem}

\begin{proof}
by induction on cast derivations
\end{proof}
\begin{lem}
Substitution Preservation

The following rule is admissible

\[
\frac{H\vdash c:C\quad H,x:C,H'\vdash a:A}{H,H'\left[x\coloneqq c\right]\vdash a\left[x\coloneqq c\right]:A\left[x\coloneqq c\right]}
\]
\end{lem}

\begin{proof}
by induction over cast derivations

\begin{tabular}{lll}
$\rulename{cast-::}$ & \multicolumn{2}{l}{$H,x:C,H'\vdash a:A$, $H,x:C,H'\vdash A:\star$, $H,x:C,H'\vdash B:\star$, well formed $\ell ,o$}\tabularnewline
 & $H,H'\left[x\coloneqq c\right]\vdash a\left[x\coloneqq c\right]:A\left[x\coloneqq c\right]$ & by induction\tabularnewline
 & $H,H'\left[x\coloneqq c\right]\vdash A\left[x\coloneqq c\right]:\star$ & by induction\tabularnewline
 & $H,H'\left[x\coloneqq c\right]\vdash B\left[x\coloneqq c\right]:\star$ & by induction\tabularnewline
 & $H,H'\left[x\coloneqq c\right]\vdash a\left[x\coloneqq c\right]::_{A\left[x\coloneqq c\right],\ell ,o\left[x\coloneqq c\right]}B\left[x\coloneqq c\right]\::\:B\left[x\coloneqq c\right]$ & $\rulename{cast-::}$\tabularnewline
other rules & ... & correspond to the inductive cases in Chapter 2\tabularnewline
\end{tabular}
\end{proof}
As before the notion of definitional equality can be extended to cast contexts in \Fref{surface-Context-Equiv}.

\begin{figure}
\[
\frac{\ }{\lozenge\equiv\lozenge}\,\rulename{\ensuremath{\equiv}-ctx-empty}
\]

\[
\frac{H\equiv H'\quad A\equiv A'}{H,x:A\equiv H',x:A'}\,\rulename{\ensuremath{\equiv}-ctx-ext}
\]

\caption{Contextual Equivalence}
\label{fig:surface-Context-Equiv}
\end{figure}

\begin{lem}
Context Preservation

the following rule is admissible

\[
\frac{\Gamma\vdash n:N\quad\Gamma\equiv\Gamma'}{\Gamma'\vdash n:N}
\]
\end{lem}

\begin{proof}
by induction over typing derivations

\begin{tabular}{lll}
$\rulename{cast-::}$ & \multicolumn{2}{l}{$H\vdash a:A$, $H\vdash A:\star$, $H\vdash B:\star$, well formed $\ell ,o$}\tabularnewline
 & $H'\vdash a:A$ & by induction\tabularnewline
 & $H'\vdash A:\star$ & by induction\tabularnewline
 & $H'\vdash B:\star$ & by induction\tabularnewline
 & $H'\vdash a::_{A,\ell ,o}B\::\:B$ & $\rulename{cast-::}$\tabularnewline
other rules & ... & correspond to the inductive cases in Chapter 2\tabularnewline
\end{tabular}
\end{proof}
As before we show inversions on the term syntaxes, generalizing the induction hypothesis up to equality, when needed.
\begin{lem}
$\mathsf{fun}$-Inversion (generalized)

\[
\frac{H\vdash\mathsf{fun}\,f\,x\Rightarrow a\,:\,C\quad C\equiv\left(x:A\right)\rightarrow B}{H,f:\left(x:A\right)\rightarrow B,x:A\vdash b:B}
\]
\end{lem}

\begin{proof}
by induction on the cast derivation

\begin{tabular}{lll}
$\rulename{cast-fun}$ & \multicolumn{2}{l}{$H,f:\left(x:A'\right)\rightarrow B',x:A'\vdash b\,:\,B'$, $\left(x:A'\right)\rightarrow B'\equiv\left(x:A\right)\rightarrow B$}\tabularnewline
 & $A'\equiv A,\quad B'\equiv B$ & by stability of fun-ty\tabularnewline
 & $H,f:\left(x:A'\right)\rightarrow B',x:A'\equiv H,f:\left(x:A\right)\rightarrow B,x:A$ & by reflexivity of $\equiv$ , extended with previous equalities\tabularnewline
 & $H,f:\left(x:A\right)\rightarrow B,x:A\vdash b\,:\,B'$ & by context preservation\tabularnewline
 & $H,f:\left(x:A\right)\rightarrow B,x:A\vdash b\,:\,B$ & $\rulename{ty-conv}$\tabularnewline
$\rulename{cast-conv}$ & \multicolumn{2}{l}{$H\vdash\mathsf{fun}\,f\,x\Rightarrow b\,:\,C'$, $C'\equiv C$, $C\equiv\left(x:A\right)\rightarrow B$}\tabularnewline
 & $C'\equiv\left(x:A\right)\rightarrow B$ & by transitivity\tabularnewline
 & ... & by induction\tabularnewline
other rules & impossible & the term position has the form $\mathsf{fun}\,f\,x\Rightarrow m$\tabularnewline
\end{tabular}
\end{proof}
This allows us to conclude the corollary 
\begin{cor}
$\mathsf{fun}$-Inversion 

\[
\frac{H\vdash\mathsf{fun}\,f\,x\Rightarrow a\,:\,\left(x:A\right)\rightarrow B}{H,f:\left(x:A\right)\rightarrow B,x:A\vdash b:B}
\]
\end{cor}

\begin{lem}
$\rightarrow$-Inversion (generalized)

The following rule is admissible
\[
\frac{H\vdash\left(x:A\right)\rightarrow B\,:\,C\quad C\equiv\star}{H\vdash A:\star\quad H,x:A\vdash B:\star}
\]
\end{lem}

\begin{proof}
By induction on the typing derivations

\begin{tabular}{lll}
$\rulename{cast-fun-ty}$ & \multicolumn{2}{l}{$H\vdash\left(x:A\right)\rightarrow B\,:\,C$}\tabularnewline
 &  & follows directly\tabularnewline
$\rulename{cast-conv}$ & \multicolumn{2}{l}{$H\vdash\left(x:A\right)\rightarrow B\::\:C'$, $C'\equiv C$}\tabularnewline
 & $C'\equiv\star$ & by transitivity\tabularnewline
 & ... & by induction\tabularnewline
other rules & impossible & since the term position has the form $\left(x:A\right)\rightarrow B$\tabularnewline
\end{tabular}
\end{proof}
leading to the corollary
\begin{cor}
$\rightarrow$-Inversion
\[
\frac{H\vdash\left(x:A\right)\rightarrow B\,:\,\star}{H\vdash A:\star\quad H,x:A\vdash B:\star}
\]
\end{cor}

\begin{lem}
$::$-Inversion

The following rule is admissible
\end{lem}

\[
\frac{H\vdash a::_{A,\ell ,o}B\::\:C}{H\vdash a:A\quad H\vdash A:\star\quad H\vdash B:\star}
\]

\todo{remove conditions for regularity?}
\begin{proof}
By induction on the typing derivations

\begin{tabular}{lll}
$\rulename{cast-::}$ & \multicolumn{2}{l}{$H\vdash a:A\quad H\vdash A:\star\quad H\vdash B:\star$}\tabularnewline
 &  & follows directly\tabularnewline
$\rulename{cast-conv}$ & \multicolumn{2}{l}{$H\vdash a::_{A,\ell ,o}B\::\:C'$, $C'\equiv C$}\tabularnewline
 & ... & by induction\tabularnewline
other rules & impossible & the term position has the form $a::_{A,\ell ,o}B$\tabularnewline
\end{tabular}
\end{proof}
Note that each of the output judgments are smaller than the input judgments, this allows other proofs to use induction on the output of this lemma.
\begin{thm}
$\Rrightarrow$-Preservation 

The following rule is admissible

\[
\frac{a\Rrightarrow a'\quad H\vdash a:A}{H\vdash a':A}
\]
\end{thm}

\begin{proof}
by induction

\begin{tabular}{llll}
$\rulename{cast-\star}$ & $\rulename{\ensuremath{\Rrightarrow}-}\star$ & $H\vdash\star\,:\,\star$, $\star\Rrightarrow\star$ & follows directly\tabularnewline
$\rulename{cast-var}$ & $\rulename{\ensuremath{\Rrightarrow}-var}$ & $H\vdash x\,:\,A$, $x\Rrightarrow x$ & follows directly\tabularnewline
$\rulename{ty-conv}$ &  & $H\vdash a\,:\,A$, $A\equiv A'$ & \tabularnewline
 & all $\Rrightarrow$ & $a\Rrightarrow a'$ & \tabularnewline
 &  & $H\vdash a'\,:\,A$ & by induction\tabularnewline
 &  & $H\vdash a'\,:\,A'$ & $\rulename{cast-conv}$\tabularnewline
$\rulename{cast-::}$ &  & well formed $\ell,o$ & \tabularnewline
 & $\rulename{\ensuremath{\Rrightarrow}-::-red}$ & $H\vdash a:\star$, $a\Rrightarrow a'$ & \tabularnewline
 &  & $H\vdash a'\,:\,\star$ & directly by induction\tabularnewline
 & $\rulename{\ensuremath{\Rrightarrow}-::}$ & \multicolumn{2}{l}{$H\vdash a:A_{1}$, $H\vdash A_{2}:\star$, $a\Rrightarrow a'$, $A_{1}\Rrightarrow A_{1}'$,
$A_{2}\Rrightarrow A_{2}'$, $o\Rrightarrow o'$}\tabularnewline
 &  & $H\vdash a'\,:\,A_{1}$ & by induction\tabularnewline
 &  & $H\vdash a'\,:\,A_{1}'$ & $\rulename{cast-conv}$\tabularnewline
 &  & $H\vdash A_{2}':\star$ & by induction\tabularnewline
 &  & $H\vdash a'::_{A_{1}',\ell,o'}A_{2}'\,:\,A_{2}'$ & $\rulename{cast-::}$\tabularnewline
 &  & $H\vdash a'::_{A_{1}',\ell,o'}A_{2}'\,:\,A_{2}$ & $\rulename{cast-conv}$\tabularnewline
$\rulename{cast-fun-ty}$ &  & $H\vdash A\,:\,\star$, $H,x:A\vdash B\,:\,\star$ & \tabularnewline
 & $\rulename{\ensuremath{\Rrightarrow}-fun-ty}$ & $A\Rrightarrow A'$, $B\Rrightarrow B'$ & \tabularnewline
 &  & $H\vdash A'\,:\,\star$ & by induction\tabularnewline
 &  & $H,x:A\vdash B':\star$ & by induction\tabularnewline
 &  & $H,x:A\equiv H,x:A'$ & by reflexivity of $\equiv$, extended with $A\equiv A'$\tabularnewline
 &  & $H,x:A'\vdash B'\,:\,\star$ & by preservation of contexts\tabularnewline
 &  & $H\vdash\left(x:A'\right)\rightarrow B'\,:\,\star$ & $\rulename{cast-fun-ty}$\tabularnewline
$\rulename{cast-fun}$ &  & $H,f:\left(x:A\right)\rightarrow B,x:A\vdash a\,:\,A$ & \tabularnewline
 & $\rulename{\ensuremath{\Rrightarrow}-fun}$ & $a\Rrightarrow a'$ & \tabularnewline
 &  & $H,f:\left(x:A\right)\rightarrow B,x:A\vdash a':A$ & by induction\tabularnewline
 &  & $H\vdash\mathsf{fun}\,f\,x\Rightarrow a'\,:\,\left(x:A\right)\rightarrow B$ & $\rulename{cast-fun}$\tabularnewline
$\rulename{cast-fun-app}$ &  &  & \tabularnewline
 & $\rulename{\ensuremath{\Rrightarrow}-fun-app-red}$ & \multicolumn{2}{l}{$H\vdash\mathsf{fun}\,f\,x\Rightarrow b\,:\,\left(x:A\right)\rightarrow B$,
$H\vdash a:A$, $a\Rrightarrow a'$, $b\Rrightarrow b'$}\tabularnewline
 &  & $\mathsf{fun}\,f\,x\Rightarrow b\Rrightarrow\mathsf{fun}\,f\,x\Rightarrow b'$ & $\rulename{\ensuremath{\Rrightarrow}-fun}$\tabularnewline
 &  & $H\vdash\mathsf{fun}\,f\,x\Rightarrow b'\,:\,\left(x:A\right)\rightarrow B$ & by induction\tabularnewline
 &  & $H,f:\left(x:A\right)\rightarrow B,x:A\vdash a'$ & by fun-inversion\tabularnewline
 &  & $H\vdash a'\,:\,A$ & by induction\tabularnewline
 &  & $H\vdash b'\left[f\coloneqq\mathsf{fun}\,f\,x\Rightarrow b',x\coloneqq a'\right]:B\left[x\coloneqq a'\right]$ & by typed substitutions\tabularnewline
 &  & $B\left[x\coloneqq a'\right]\equiv M\left[x\coloneqq a\right]$ & by substitution by steps, $\equiv$ symmetry\tabularnewline
 &  & $H\vdash b'\left[f\coloneqq\mathsf{fun}\,f\,x\Rightarrow b',x\coloneqq a'\right]:B\left[x\coloneqq A\right]$ & $\rulename{cast-conv}$\tabularnewline
 & $\rulename{\ensuremath{\Rrightarrow}-fun-app}$ & $H\vdash a\,:\,\left(x:A\right)\rightarrow B$, $H\vdash a:A$, $a\Rrightarrow a'$,
$b\Rrightarrow b'$ & \tabularnewline
 &  & $H\vdash b'\,:\,\left(x:B\right)\rightarrow A$ & by induction\tabularnewline
 &  & $H\vdash A':A$ & by induction\tabularnewline
 &  & $H\vdash b'\,a':\,B\left[x\coloneqq a'\right]$ & $\rulename{cast-fun-app}$\tabularnewline
 &  & $B\left[x\coloneqq a'\right]\equiv B\left[x\coloneqq a\right]$ & by substitution by steps, $\equiv$ symmetry\tabularnewline
 &  & $H\vdash b'\left[f\coloneqq\mathsf{fun}\,f\,x\Rightarrow b',x\coloneqq a'\right]:B\left[x\coloneqq a\right]$ & $\rulename{cast-conv}$\tabularnewline
 & $\rulename{\ensuremath{\Rrightarrow}-fun-::-red}$ & \multicolumn{2}{l}{$H\vdash\left(b::_{\left(x:A_{1}\right)\rightarrow B_{1},\ell ,o}\left(x:A_{2}\right)\rightarrow B_{2}\right):\left(x:A_{2}\right)\rightarrow B_{2}$,
$H\vdash a:A_{2}$, }\tabularnewline
 &  & \multicolumn{2}{l}{$b\Rrightarrow b'$, $a\Rrightarrow a'$, $A_{1}\Rrightarrow A_{1}'$,
$A_{2}\Rrightarrow A_{2}'$, $B_{1}\Rrightarrow B_{1}'$, $B_{2}\Rrightarrow B_{2}'$,
$o\Rrightarrow o'$, }\tabularnewline
 &  & $H\vdash a':A_{2}$ & by induction\tabularnewline
 &  & $H\vdash a':A_{2}'$ & $\rulename{cast-conv}$\tabularnewline
 &  & $H\vdash b:\left(x:A_{1}\right)\rightarrow B_{1}$, $H\vdash\left(x:A_{1}\right)\rightarrow B_{1}:\star$,
$H\vdash\left(x:A_{2}\right)\rightarrow B_{2}:\star$ & cast-inversion \tabularnewline
 &  & $\left(x:A_{2}\right)\rightarrow B_{2}\Rrightarrow\left(x:A_{2}'\right)\rightarrow B_{2}'$ & $\rulename{\ensuremath{\Rrightarrow}-fun-ty}$\tabularnewline
 &  & $H\vdash\left(x:A_{2}'\right)\rightarrow B_{2}':\star$ & by induction with $H\vdash\left(x:A_{2}\right)\rightarrow B_{2}:\star$,
\footnote{well founded since cast-inversion produces smaller judgments}\tabularnewline
 &  & $H\vdash A_{2}':\star$, $H,x:A_{2}'\vdash B_{2}':\star$ & fun-ty-inversion\tabularnewline
 &  & $\left(x:A_{1}\right)\rightarrow B_{1}\Rrightarrow\left(x:A_{1}'\right)\rightarrow B_{1}'$ & $\rulename{\ensuremath{\Rrightarrow}-fun-ty}$\tabularnewline
 &  & $H\vdash\left(x:A_{1}'\right)\rightarrow B_{1}':\star$ & by induction with $H\vdash\left(x:A_{1}\right)\rightarrow B_{1}:\star$,
\footnote{well founded since cast-inversion produces smaller judgments}\tabularnewline
 &  & $H\vdash A_{1}':\star$, $H,x:A_{1}'\vdash B_{1}':\star$ & fun-ty-inversion\tabularnewline
 &  & let $ac=a'::_{A_{2}',\ell,o'.arg}A_{1}'$ & \tabularnewline
 &  & $H\vdash ac:A_{1}'$ & $\rulename{cast-::}$\tabularnewline
 &  & $H\vdash b':\left(x:A_{1}\right)\rightarrow B_{1}$ & by induction with $H\vdash b:\left(x:A_{1}\right)\rightarrow B_{1}$,
\footnote{well founded since cast-inversion produces smaller judgments}\tabularnewline
 &  & $H\vdash b':\left(x:A_{1}'\right)\rightarrow B_{1}'$ & $\rulename{cast-conv}$\tabularnewline
 &  & $H\vdash b'\ ac:B_{1}'\left[x\coloneqq ac\right]$ & $\rulename{cast-fun-app}$\tabularnewline
 &  & $H\vdash B_{1}'\left[x\coloneqq ac\right]:\star$ & by substitution preservation\tabularnewline
 &  & $H\vdash B_{2}'\left[x\coloneqq a'\right]:\star$ & by substitution preservation\tabularnewline
 &  & $H\vdash\left(b'\ ac\right)::_{B_{1}'\left[x\coloneqq ac\right],\ell ,o'.bod[a']}B_{2}'\left[x\coloneqq a'\right]$ & $\rulename{cast-::}$\tabularnewline
\end{tabular}
\end{proof}
\todo{both vertically and horz too big}

\todo{highlight the -fun-::-red case}

\subsubsection{Progress}

\begin{figure}
\[
\frac{\,}{\star\,\textbf{Val}}\rulename{Val-\star}
\]
\[
\frac{\,}{\left(x:A\right)\rightarrow B\,\textbf{Val}}\rulename{Val-fun-ty}
\]
\[
\frac{\,}{\mathsf{fun}\,f\,x\Rightarrow b\:\textbf{Val}}\rulename{Val-fun}
\]
\[
\frac{\begin{array}{c}
a\:\textbf{Val}\quad A\:\textbf{Val}\quad B\:\textbf{Val}\\
a\cancel{=}\star\\
a\cancel{=}\left(x:C\right)\rightarrow C'
\end{array}}{a::_{A,\ell o}B\:\textbf{Val}}\rulename{Val-::}
\]
\caption{Cast Language Values}
\label{fig:cast-val}
\end{figure}

Unlike the surface language, it is no longer practical to characterize values syntactically.
Values are specified by judgments in \Fref{cast-val}. 
They are standard except for the $\rulename{Val-::}$, which states that a type ($\star$ or function type) under a cast is not a value.

\begin{figure}
\[
\frac{a\,\textbf{Val}}{\left(\mathsf{fun}\,f\,x\Rightarrow b\right)a\rightsquigarrow b\left[f\coloneqq\mathsf{fun}\,f\,x\Rightarrow b,x\coloneqq a\right]}
\]
\[
\frac{b\,\textbf{Val}\quad a\,\textbf{Val}}{\begin{array}{c}
\left(b::_{\left(x:A_{1}\right)\rightarrow B_{1},\ell ,o}\left(x:A_{2}\right)\rightarrow B_{2}\right)a\rightsquigarrow\\
\left(b\,a::_{A_{2},\ell,o.arg}A_{1}\right)::_{B_{1}\left[x\coloneqq a::_{A_{2},\ell,o.arg}A_{1}\right],\ell ,o.bod[a]}B_{2}\left[x\coloneqq a\right]
\end{array}}
\]
\[
\frac{a\,\textbf{Val}}{a::_{\star,\ell ,o}\star\rightsquigarrow a}
\]
\[
\frac{a\rightsquigarrow a'}{a::_{A,\ell ,o}B\rightsquigarrow a'::_{A,\ell ,o}B}
\]
\[
\frac{a\,\textbf{Val}\quad A\rightsquigarrow A'}{a::_{A,\ell ,o}B\rightsquigarrow a::_{A',\ell ,o}B}
\]
\[
\frac{a\,\textbf{Val}\quad A\,\textbf{Val}\quad B\rightsquigarrow B'}{a::_{A,\ell ,o}B\rightsquigarrow a::_{A,\ell ,o}B'}
\]
\[
\frac{b\rightsquigarrow b'}{b\,a\rightsquigarrow b'\,a}
\]
\[
\frac{b\,\textbf{Val}\quad a\rightsquigarrow a'}{b\,a\rightsquigarrow b\,a'}
\]

\todo[inline]{name rules}
\caption{Cast Language Small Step}
\label{fig:cast-step}
\end{figure}

Small steps are listed in \Fref{cast-step}.
They are standard for call-by-value except that casts can distribute over application, and casts can reduce when both types are $\star$.

\begin{figure}
\[
\frac{\,}{\textbf{Blame}\:\ell \,o\,\left(a::_{\left(x:A\right)\rightarrow B,\ell ,o}\star\right)}
\]
\[
\frac{\,}{\textbf{Blame}\:\ell \,o\,\left(a::_{\star,\ell ,o}\left(x:A\right)\rightarrow B\right)}
\]
\[
\frac{\textbf{Blame}\:\ell \,o\,a}{\textbf{Blame}\:\ell \,o\,\left(a::_{A,\ensuremath{\ell'},o'}B\right)}
\]
\[
\frac{\textbf{Blame}\:\ell \,o\,A}{\textbf{Blame}\:\ell \,o\,\left(a::_{A,\ensuremath{\ell'},o'}B\right)}
\]
\[
\frac{\textbf{Blame}\:\ell \,o\,B}{\textbf{Blame}\:\ell \,o\,\left(a::_{A,\ensuremath{\ell'},o'}B\right)}
\]
\[
\frac{\textbf{Blame}\:\ell \,o\,b}{\textbf{Blame}\:\ell \,o\,\left(b\,a\right)}
\]
\[
\frac{\textbf{Blame}\:\ell \,o\,a}{\textbf{Blame}\:\ell \,o\,\left(b\,a\right)}
\]
\todo[inline]{name rules}\caption{Cast Language Blame}
\label{fig:cast-blame}
\end{figure}

%% walk through blame
In addition to small step and values we also specify blame judgments in \Fref{cast-blame}.
Blame tracks the information needed to create a good error message and is inspired by the many systems that use blame tracking \cite{10.1145/581478.581484,10.1007/978-3-642-00590-9_1,wadler:LIPIcs:2015:5033}.
Specifically the judgment $\textbf{Blame}\:\ell \,o\,a$ means that $a$ witnesses an a contradiction in the source code at location $\ell $ under the observations $o$.
With only dependent functions and universes, only inequalities of the form $*\,\cancel{=}\,A\rightarrow B$ can be witnessed.
The first 2 rules of the blame judgment witness these concrete type inequalities.
The rest of the blame rules will recursively extract concrete witnesses from larger terms.
The limited amount of observation is the main reason why the theory in this chapter is tractable.
% "self evidently correct" since it is clear to only extract inequalities. like step and val? one of several possible contradiction extraction relations
\begin{fact}
$\rightsquigarrow$ preserves types 

since the following rule is admissible
\end{fact}

\[
\frac{m\rightsquigarrow m'}{m\Rrightarrow m'}
\]

As in Chapter 2 we will need technical lemmas that determine the form of a value of a type in the empty context.
However, canonical function values look different because they must account for the possibility of blame arising from a stuck term.
\begin{lem}
$\star$-Canonical forms (generalized)

If $\vdash a\,:\,A$ , $a\,\textbf{Val}$, and $A\equiv\star$ then
either

\textup{$a=\star$ ,}

\textup{or there exists $C$, $B$, such that $a=\left(x:C\right)\rightarrow B$}
\end{lem}

\todo{alternatively produce the blame judgment}
\begin{proof}
by induction on the cast derivation

\begin{tabular}{lll}
$\rulename{cast-\star}$ & $\vdash\star:\star$ & follows since $a=\star$\tabularnewline
$\rulename{cast-fun-ty}$ & $\vdash\left(x:A\right)\rightarrow B\,:\,\star$ & follows since $a=\left(x:A\right)\rightarrow B$\tabularnewline
$\rulename{ty-conv}$ & $\vdash a:A$, $a\,\textbf{Val}$, $A\equiv A'$, $A'\equiv\star$ & which concluded $\vdash a\,:\,A'$\tabularnewline
 & $A'\equiv\star$ & by transitivity, symmetry\tabularnewline
 & $a=\star$ or there exists $C$, $B$, such that $a=\left(x:C\right)\rightarrow B$  & by induction\tabularnewline
$\rulename{cast-::}$ & $\vdash a:A_{1}$, $a::_{A_{1},\ell ,o}A_{2}\:\textbf{Val}$,$\vdash A_{1}:\star$,
$\vdash A_{2}:\star$, $A_{2}\equiv\star$ & \tabularnewline
 & $a\cancel{=}\star,a\cancel{=}\left(x:C\right)\rightarrow B$, $a\:\textbf{Val}$ & since it must have been a value by $\rulename{Val-::}$ \tabularnewline
 & but $a=\star$ or there exists $C$, $B$, such that $a=\left(x:C\right)\rightarrow B$  & by induction \tabularnewline
 & ! & so $\rulename{cast-::}$ case was impossible\tabularnewline
$\rulename{cast-fun}$ & $f:\left(x:A\right)\rightarrow B,x:A\vdash b:B$, $\left(x:A\right)\rightarrow B\equiv\star$ & \tabularnewline
 & $\left(x:A\right)\rightarrow B\cancel{\equiv}\star$ & by the stability of $\equiv$\tabularnewline
 & ! & so $\rulename{cast-fun}$ case was impossible\tabularnewline
other rules & impossible & since they do not type values in an empty ctx\tabularnewline
\end{tabular}
\end{proof}
Leading to the corollary,
\begin{cor}
$\star$-Canonical forms

If $\vdash A:\star$, and $A\,\textbf{Val}$ then either 

\textup{$A=\star$ , }

\textup{or there exists $C$, $B$, such that $A=\left(x:C\right)\rightarrow B$}
\end{cor}

\begin{proof}
by reflexivity of $\equiv$
\end{proof}
Likewise
\begin{lem}
$\rightarrow$-Canonical forms (generalized)

If $\vdash a\,:\,A$ , $a\,\textbf{Val}$, and $A\equiv\left(x:C\right)\rightarrow B$
then either

$a=\mathsf{fun}\,f\,x\Rightarrow b$ 

or $a=d::_{D,\ell ,o}\left(x:C'\right)\rightarrow B'$,
$d\,\textbf{Val}$, $D\,\textbf{Val}$, $C'\equiv C$, $B'\equiv B$ 
\end{lem}

\todo{alternatively produce the blame judgment}
\begin{proof}
by induction on the cast derivation

\begin{tabular}{lll}
$\rulename{cast-\star}$ & $\star\equiv\left(x:C\right)\rightarrow B$ & \tabularnewline
 & $\star\cancel{\equiv}\left(x:C\right)\rightarrow B$ ! & by the stability of $\equiv$\tabularnewline
$\rulename{cast-fun-ty}$ & $\star\equiv\left(x:C\right)\rightarrow B$ & \tabularnewline
 & $\star\cancel{\equiv}\left(x:C\right)\rightarrow B$ ! & by the stability of $\equiv$\tabularnewline
$\rulename{cast-fun}$ & \multicolumn{2}{l}{$f:\left(x:C'\right)\rightarrow B',x:C'\vdash b:B'$, $\left(x:C'\right)\rightarrow B'\equiv\left(x:C\right)\rightarrow B$}\tabularnewline
 &  & follows directly\tabularnewline
$\rulename{cast-::}$ & $\vdash a:A_{1}$, $\vdash A_{1}:\star$, $\vdash A_{2}:\star$, $A_{2}\equiv\left(x:C\right)\rightarrow B$ & \tabularnewline
 & $a\cancel{=}\star,a\cancel{=}\left(x:C\right)\rightarrow B$, $a\:\textbf{Val}$,
$A_{1}\:\textbf{Val}$, $A_{2}\:\textbf{Val}$ & since it must have been a value by $\rulename{Val-::}$\tabularnewline
 & $A_{2}=\left(x:C'\right)\rightarrow B'$ & by the stability of $\equiv$, $A_{2}\:\textbf{Val}$\footnote{TODO: make an explicit lemma?}\tabularnewline
 & $C'\equiv C$, $B'\equiv B$ & by the stability of $\equiv$\tabularnewline
$\rulename{ty-conv}$ & $\vdash a:A$, $A\equiv A'$, $A'\equiv\left(x:C\right)\rightarrow B$ & \tabularnewline
 & $A\equiv\left(x:C\right)\rightarrow B$ & by transitivity\tabularnewline
 & ... & by induction\tabularnewline
other rules & impossible & since they do not type values of $\star$\tabularnewline
\end{tabular}
\end{proof}
As a corollary
\begin{cor}
$\rightarrow$-Canonical forms

If $\vdash a:\left(x:C\right)\rightarrow B$ , and $a\,\textbf{Val}$

$a=\mathsf{fun}\,f\,x\Rightarrow b$ 

or $a=d::_{D,\ell ,o}\left(x:C'\right)\rightarrow B'$,
$d\,\textbf{Val}$, $D\,\textbf{Val}$, $C'\equiv C$, $B'\equiv B$ 
\end{cor}

\begin{proof}
by reflexivity of $\equiv$
\end{proof}
\begin{cor}
$\rightarrow$-Canonical terms

If $\vdash a:\left(x:C\right)\rightarrow B$ , and $a\,\textbf{Val}$
then $a$is not a type, $a\cancel{=}\star,a\cancel{=}\left(x:C\right)\rightarrow C'$
\end{cor}

\begin{thm}
Progress

If $\vdash a\,:\,A$ then either 

$a\,\textbf{Val}$

there exists $a'$ such that $a\rightsquigarrow a'$

or there exists $\ell$, $o$ such that $\textbf{Blame}\:\ell \,o\,a$
\end{thm}

\begin{proof}
As usual this follows form induction on the typing derivation

\begin{tabular}{lllll}
$\rulename{cast-var}$ & $\vdash\star\,:\,\star$ &  &  & \tabularnewline
 & $\star\,\textbf{Val}$ &  &  & $\rulename{Val-\star}$\tabularnewline
$\rulename{cast-var}$ & $\vdash x:A$ &  &  & impossible in an empty context\tabularnewline
$\rulename{cast-conv}$ & $\vdash a:A'$, $A'\equiv A$ &  &  & \tabularnewline
 & \multicolumn{3}{l}{$a\,\textbf{Val}$, there exists $a'$ such that $a\rightsquigarrow a'$,
or there exists $\ell$, $o$ such that $\textbf{Blame}\:\ell \,o\,a$} & by induction on $\vdash a:A'$\tabularnewline
$\rulename{cast-::}$ & $\vdash a:\,A$, $\vdash A:\star$, $\vdash B:\star$ &  &  & \tabularnewline
 & \multicolumn{3}{l}{$a\,\textbf{Val}$, there exists $a'$ such that $a\rightsquigarrow a'$,
or there exists $\ell_{a}$, $o_{a}$ such that $\textbf{Blame}\:\ell _{a}\,o_{a}\,a$} & by induction\tabularnewline
 & \multicolumn{3}{l}{$A\,\textbf{Val}$, there exists $A'$ such that $A\rightsquigarrow A'$,
or there exists $\ell_{A}$, $o_{A}$ such that $\textbf{Blame}\:\ell _{A}\,o_{A}\,A$} & by induction\tabularnewline
 & \multicolumn{3}{l}{$B\,\textbf{Val}$, there exists $B'$ such that $B\rightsquigarrow B'$,
or there exists $\ell_{B}$, $o_{B}$ such that $\textbf{Blame}\:\ell _{B}\,o_{B}\,B$} & by induction\tabularnewline
 & if $a\rightsquigarrow a'$,  & $a::_{A,\ell ,o}B\rightsquigarrow a'::_{A,\ell ,o}B$ &  & \tabularnewline
 & if $a\,\textbf{Val}$, $A\rightsquigarrow A'$, & $a::_{A,\ell ,o}B\rightsquigarrow a::_{A',\ell ,o}B$ &  & \tabularnewline
 & if $a\,\textbf{Val}$, $A\,\textbf{Val}$, $B\rightsquigarrow B'$ & $a::_{A,\ell ,o}B\rightsquigarrow a::_{A,\ell ,o}B'$ &  & \tabularnewline
 & if $a\,\textbf{Val}$, $A\,\textbf{Val}$, $B\,\textbf{Val}$, &  &  & \tabularnewline
 &  & $A=\star$ or $A=\left(x:C_{A}\right)\rightarrow D_{A}$ &  & by canonical forms of $\star$\tabularnewline
 &  & $B=\star$ or $B=\left(x:C_{B}\right)\rightarrow D_{B}$ &  & by canonical forms of $\star$\tabularnewline
 &  & if $A=\star$, $B=\star$  & $a::_{\star,\ell ,o}\star\rightsquigarrow a$ & \tabularnewline
 &  & if $A=\left(x:C_{A}\right)\rightarrow D_{A}$, $B=\left(x:C_{B}\right)\rightarrow D_{B}$ &  & \tabularnewline
 &  &  & $a\cancel{=}\star,a\cancel{=}\left(x:C\right)\rightarrow C'$ & by canonical forms of fun \tabularnewline
 &  &  & $a::_{A,\ell o}B\:\textbf{Val}$ & \tabularnewline
 &  & if $A=\star$, $B=\left(x:C_{B}\right)\rightarrow D_{B}$  & $\textbf{Blame}\:\ell \,o\,\left(a::_{\star,\ell ,o}\left(x:C_{B}\right)\rightarrow D_{B}\right)$ & \tabularnewline
 &  & if $A=\left(x:C_{A}\right)\rightarrow D_{A}$, $B=\star$ & $\textbf{Blame}\:\ell \,o\,\left(a::_{\left(x:C_{A}\right)\rightarrow B_{A},\ell ,o}\star\right)$ & \tabularnewline
 & \multicolumn{2}{l}{if there exists $\ell_{a}$, $o_{a}$ such that $\textbf{Blame}\:\ell _{a}\,o_{a}\,a$} & $\textbf{Blame}\:\ell _{a}\,o_{a}\,\left(a::_{A,\ell ,o}B\right)$ & \tabularnewline
 & \multicolumn{2}{l}{if there exists $\ell_{A}$, $o_{A}$ such that $\textbf{Blame}\:\ell _{A}\,o_{A}\,A$} & $\textbf{Blame}\:\ell _{A}\,o_{A}\,\left(a::_{A,\ell ,o}B\right)$ & \tabularnewline
 & \multicolumn{2}{l}{if there exists $\ell_{B}$, $o_{B}$ such that $\textbf{Blame}\:\ell _{B}\,o_{B}\,B$} & $\textbf{Blame}\:\ell _{B}\,o_{B}\,\left(a::_{A,\ell ,o}B\right)$ & \tabularnewline
$\rulename{cast-fun-ty}$ & $\vdash\left(x:A\right)\rightarrow B\,:\,\star$ &  &  & \tabularnewline
 & $\left(x:A\right)\rightarrow B\,\textbf{Val}$ &  &  & $\rulename{Val-fun-ty}$\tabularnewline
$\rulename{cast-fun-app}$ & $\vdash\mathsf{fun}\,f\,x\Rightarrow b\,:\,\left(x:A\right)\rightarrow B$ &  &  & \tabularnewline
 & $\mathsf{fun}\,f\,x\Rightarrow b\:\textbf{Val}$ &  &  & $\rulename{Val-fun}$\tabularnewline
$\rulename{cast-fun-app}$ & \multicolumn{2}{l}{$\vdash b\,:\,\left(x:A\right)\rightarrow B$, $\Gamma\vdash a\,:\,A$} & \tabularnewline
 & \multicolumn{3}{l}{$a\,\textbf{Val}$, there exists $a'$ such that $a\rightsquigarrow a'$,
or there exists $\ell_{a}$, $o_{a}$ such that $\textbf{Blame}\:\ell _{a}\,o_{a}\,a$} & by induction\tabularnewline
 & \multicolumn{3}{l}{$b\,\textbf{Val}$, there exists $b'$ such that $b\rightsquigarrow b'$,
or there exists $\ell_{b}$, $o_{b}$ such that $\textbf{Blame}\:\ell _{b}\,o_{b}\,b$} & by induction\tabularnewline
 & if $b\rightsquigarrow b'$, & $b\,a\rightsquigarrow b'\,a$ &  & \tabularnewline
 & if $b\,\textbf{Val}$, $a\rightsquigarrow a'$, & $b\,a\rightsquigarrow b\,a'$ &  & \tabularnewline
 & if $b\,\textbf{Val}$, $a\,\textbf{Val}$, & \multicolumn{2}{l}{$b=\mathsf{fun}\,f\,x\Rightarrow c$ or $b=d_{b}::_{D_{b},\ell _{b}\,o_{b}}\left(x:A'\right)\rightarrow B'$,
$d_{b}\,\textbf{Val}$, $D_{b}\,\textbf{Val}$, $A'\equiv A$, $B'\equiv B$\footnote{todo clean up extra conclusions}} & by canonical forms of functions\tabularnewline
 &  & if $b=\mathsf{fun}\,f\,x\Rightarrow c$ & $\left(\mathsf{fun}\,f\,x\Rightarrow c\right)a\rightsquigarrow c\left[f\coloneqq\mathsf{fun}\,f\,x\Rightarrow c,x\coloneqq a\right]$ & \tabularnewline
 &  & \multicolumn{2}{l}{$b=d_{b}::_{D_{b},\ell _{b},o_{b}}\left(x:A'\right)\rightarrow B'$,
$d_{b}\,\textbf{Val}$, $D_{b}\,\textbf{Val}$, $A'\equiv A$, $B'\equiv B$} & \tabularnewline
 &  &  & $\vdash D_{b}:\star$ & \tabularnewline
 &  &  & $D_{b}=\star$ or $D_{b}=\left(x:A_{D_{b}}\right)\rightarrow B_{D_{b}}$ & by canonical forms of $\star$\tabularnewline
 &  &  & if $D_{b}=\star$,  & \tabularnewline
 &  &  & $\textbf{Blame}\:\ell _{b}\,o_{b}\,\left(b::_{\star,\ell _{b},o_{b}}\left(x:A'\right)\rightarrow B'\right)$ & \tabularnewline
 &  &  & if $D_{b}=D_{b}=\left(x:A_{D_{b}}\right)\rightarrow B_{D_{b}}$, & \tabularnewline
 &  &  & let $a_{c}=a::_{A',\ell _{b},o_{b}.arg}A_{D_{b}}$ & \tabularnewline
 &  &  & $\left(d_{b}::_{\left(x:A_{D_{b}}\right)\rightarrow B_{D_{b}},\ell _{b},o_{b}}\left(x:A'\right)\rightarrow B'\right)a\rightsquigarrow$ & \tabularnewline
 &  &  & $\left(d_{b}\,a_{c}\right)::_{B_{D_{b}}\left[x\coloneqq a_{c}\right],\ell ,o.bod[a]}B'\left[x\coloneqq a\right]$ & \tabularnewline
 & \multicolumn{2}{l}{if there exists $\ell_{b}$, $o_{b}$ such that $\textbf{Blame}\:\ell _{b}\,o_{b}\,b$} & $\textbf{Blame}\:\ell _{b}\,o_{b}\,\left(b\ a\right)$ & \tabularnewline
 & \multicolumn{2}{l}{if there exists $\ell_{a}$, $o_{a}$ such that $\textbf{Blame}\:\ell _{a}\,o_{a}\,a$} & $\textbf{Blame}\:\ell _{a}\,o_{a}\,\left(b\ a\right)$ & \tabularnewline
\end{tabular}
\end{proof}

\subsection{Cast Soundness}

\todo{revise}

%% cast soundness
We can now prove cast soundness.

For any $\lozenge\vdash c:C$, $c'$, $c\rightsquigarrow^{*}c'$, if $\textbf{Stuck}\,c'$ then $\textbf{Blame}\:\ell \,o\:c'$, where $\textbf{Stuck}\,c'$ means $c'$ is not a value and $c'$ does not step.
This follows by iteration the progress and preservation lemmas.

\subsection{Discussion}

\todo{inferablility of inner cast}

\todo{regularity encoding, along with the cast}

Because of the conversion rule and non-termination, cast-checking is undecidable.
All previous arguments from Chapter 2 apply to why this may be acceptable, but the most relevant is that the system should only be used through the Elaboration procedure described in the next section, which avoids the need to cast check.

\todo{example}

As in the surface languages, the cast language is logically unsound, by design.

Just as there are many different flavors of definitional equality that could have been used in Chapter 2, there are also many possible degrees that runtime equality can be enforced.
The \textbf{Blame} relation in \Fref{cast-blame} outlines the minimal possible checking to support cast soundness.
For instance\footnote{assuming the data types of chapter 5}, $\mathtt{head}\,\mathbb{B}\,1\,\left(\mathtt{rep}\,\mathbb{B}\,true\,0\right)$ will result in blame since $1$ and $0$ have different head constructors.
But $\mathtt{head}\,\mathbb{B}\,1\,\left(\mathtt{rep}\,\mathbb{B}\,true\,9\right)$ will not result in blame since $1$ and $9$ have the same head constructor and the computation can reduce to $true$. 

It is likely that more aggressive checking is preferable in practice, especially in the presence of data types.
That is why in our implementation we check equalities up to call-by-value. 

This behavior is consistent with the conjectured partial correctness of logically unsound Call-by-Value execution for dependent types in \cite{jia2010dependent}. 

\todo{move?}

Unlike static type-checking, these runtime checks have runtime costs.
Since the language allows nontermination, checks can take forever to resolve.
We don't expect this to be an issue in practice, since we could limit the number of steps allowed.
Additionally, the implementation avoids casts when it knows that blame is impossible.